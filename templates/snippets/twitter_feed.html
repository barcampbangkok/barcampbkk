<script src="/site_media/static/pinax/js/jquery-1.3.2.min.js" type="text/javascript"></script>
<script language="javascript">
    var feed = []
    var twitterUsername = 'barcampbangkok';
    var hashtag = 'thestar7';
    fetch_tweets_user_timeline();
    fetch_tweets_from_hash_tags();

    function fetch_tweets_user_timeline() {
        var url = "http://twitter.com/status/user_timeline/" +
            twitterUsername +
            ".json?count=5&callback=?";
        $.getJSON( url, user_timeline_call_back );
    }

    function user_timeline_call_back( results ) {
        add_to_feed( results, timeline_to_feed_item )
        feed.sort(sort_by_date)
        var list = feed_to_html();
        $( "#output" ).html( list );
    }

    function fetch_tweets_from_hash_tags() {
        var url = "http://search.twitter.com/search.json?q=" + hashtag + "&callback=?"
        $.getJSON( url, hash_tags_call_back );
    }

    function hash_tags_call_back ( data ) {
        add_to_feed( data.results, search_result_to_feed_item )
        feed.sort(sort_by_date)
        var list = feed_to_html();
        $( "#output" ).html( list );
    }

    function sort_by_date(a, b) {
        return a.created_at < b.created_at
    }

    function add_to_feed( results, to_feed_item_fn ) {
        $.each( results, function (index, result) {
            var feed_item = to_feed_item_fn( result ); 
            feed.push(feed_item);
        });
    }

    function search_result_to_feed_item( search_result ) {
        var feed_item = { "text": search_result.text,
                          "created_at": string_to_date(search_result.created_at),
                          "from_user": search_result.from_user
                        }
        return feed_item 
    }

    function timeline_to_feed_item( timeline ) {
        var feed_item = { "text": timeline.text,
                          "created_at": string_to_date(timeline.created_at),
                          "from_user": twitterUsername
                        }
        return feed_item 
    }

    function feed_to_html() {
        var list = $( "<ul />" );
        $.each( feed, function( index, item ) {
            var str = item.from_user + ":" + item.text + "(" + item.created_at + ")";
            var element = $( "<li />").text(str);
            element.appendTo( list );
        });
        return list;
    }

    function string_to_date(string) {
        return new Date(Date.parse(string));
    }
</script>

<div id="output"></div>
