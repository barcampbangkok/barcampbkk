<script src="/site_media/static/pinax/js/jquery-1.3.2.min.js" type="text/javascript"></script>
<script language="javascript">
    var feed = [];
    var twitter_username = 'barcampbangkok';
    var max_timeline = 5;
    var hashtag = 'thestar7';
    twitter_hashtags();
    twitter_timeline(twitter_username, max_timeline);

    function twitter_timeline(username, count) {
        var url = "http://twitter.com/status/user_timeline/" +
            username +
            ".json?count=" + count + "&callback=?";
        $.getJSON(url, twitter_timeline_call_back);
    }

    function twitter_timeline_call_back(results) {
        add_to_feed(results, timeline_to_feed_item);
        feed.sort(sort_by_date);
        update_output();
    }

    function twitter_hashtags() {
        var url = "http://search.twitter.com/search.json?q=" + hashtag + "&callback=?"
        $.getJSON( url, twitter_hashtags_call_back );
    }

    function twitter_hashtags_call_back (data) {
        add_to_feed(data.results, hashtag_to_feed_item);
        feed.sort(sort_by_date);
        update_output();
    }

    function sort_by_date(a, b) {
        return a.created_at < b.created_at;
    }

    function add_to_feed(results, to_feed_item_fn) {
        $.each( results, function (index, result) {
            var feed_item = to_feed_item_fn(result); 
            feed.push(feed_item);
        });
    }

    function hashtag_to_feed_item(search_result) {
        var feed_item = { "text": search_result.text,
                          "created_at": string_to_date(search_result.created_at),
                          "from_user": search_result.from_user,
                          "profile_image": search_result.profile_image_url 
                        };
        return feed_item;
    }

    function timeline_to_feed_item(timeline) {
        var feed_item = { "text": timeline.text,
                          "created_at": string_to_date(timeline.created_at),
                          "from_user": twitter_username,
                          "profile_image": timeline.user.profile_image_url 
                        };
        return feed_item; 
    }

    function feed_to_html() {
        var list = $("<div/>");
        $.each( feed, function( index, item ) {
            var profile = $("<img/>").attr("src", item.profile_image);
            var str = item.from_user + ":" + item.text + "(" + item.created_at + ")";
            var element = $("<p/>").text(str);
            profile.appendTo(element);
            element.appendTo(list);
        });
        return list;
    }

    function string_to_date(string) {
        return new Date(Date.parse(string));
    }

    function update_output() {
        var list = feed_to_html();
        $("#output").html(list);
    }
</script>

<div id="output"></div>
